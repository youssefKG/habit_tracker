import { useState, useEffect } from "react";
import { NewHabit, Reminder } from "@/types/habit.type";
import { DateTimePickerEvent } from "@react-native-community/datetimepicker";
import useBottomSheetModal from "../useBottomSheet";
import { Category } from "@/types/category";
import { useDataSource } from "@/context/dbContext";

const newHabitDefaultValues: NewHabit = {
  name: "youssef",
  description: "the first habit",
  frequency: "none",
  reminders: [],
  color: "#FF6B6B",
  targetPerDay: 1,
  requiredLogs: 1,
};
const defaultNewCategory = {
  name: "",
  icon: "question",
  library: "AntDesign",
};

const useNewHabit = () => {
  const [newHabit, setNewHabit] = useState<NewHabit>(newHabitDefaultValues);
  const [newReminders, setNewReminders] = useState<Reminder[]>([]);
  const [timePickerDate, setTimePickerDate] = useState<Date>(new Date());
  const [isTimePickerOpen, setIsTimePickerOpen] = useState<boolean>(false);
  const [categories, setCategories] = useState<Category[]>([]);
  const [newCategory, setNewCategory] =
    useState<Omit<Category, "id">>(defaultNewCategory);

  // context start
  const {
    habitRepository,
    reminderRepository,
    dayRepository,
    categoryRepositroy,
  } = useDataSource();
  // context end

  // modals  start
  const [
    reminderBottomSheetRef,
    openReminderBottomSheet,
    closeReminderBottomSheet,
  ] = useBottomSheetModal();
  const [
    categoriesBottomSheetRef,
    openCategoriesBottomSheet,
    closeCategoriesBottomSheet,
  ] = useBottomSheetModal();
  const [
    newCateogyBottomSheetRef,
    openNewCategoryBottomSheet,
    closeNewCategoryBottomSheet,
  ] = useBottomSheetModal();
  const [iconsBottomSheetRef, openIconsBottomSheet, closeIconsBottmSheet] =
    useBottomSheetModal();

  const [
    newHabitBottomSheetRef,
    openNewHabitBottomSheet,
    closeNewHabitBottomSheet,
  ] = useBottomSheetModal();

  // new habit
  const onCloseNewHabitBottomSheet = () => {
    setNewHabit(newHabitDefaultValues);
    closeNewHabitBottomSheet();
    closeCategoriesBottomSheet();
    closeReminderBottomSheet();
    closeIconsBottmSheet();
  };

  // fieldes changes (name, description...)
  const handleNewHabitFieldChange = (key: keyof NewHabit, value: string) => {
    if (key === "targetPerDay") {
      if (/^\d*$/.test(value)) {
        setNewHabit((prev) => ({ ...prev, targetPerDay: parseInt(value) }));
      }
    } else {
      setNewHabit((prevNewHabit) => ({ ...prevNewHabit, [key]: value }));
    }
  };

  // reminders  start
  const openTimePicker = () => {
    setIsTimePickerOpen(true);
  };

  const onChangeNewReminderTime = (
    _: DateTimePickerEvent,
    selectedData?: Date,
  ) => {
    const currentDate: Date = selectedData ?? new Date();
    setTimePickerDate(currentDate);
    setIsTimePickerOpen(false);
  };

  const addNewReminder = () => {
    const time = new Date();
    const days = ["Mon", "Tues", "Wed", "Thu", "Friy"];
    setNewReminders((prevNewReminders) => [
      ...prevNewReminders,
      {
        time,
        days,
        id: prevNewReminders.length + 1,
        index: prevNewReminders.length + 1,
      },
    ]);
  };

  const toggleNewReminderDay = (day: string, newReminderId: number) => {
    setNewReminders((prevNewReminders: Reminder[]) => {
      return prevNewReminders.map((newReminder: Reminder) => {
        if (newReminderId === newReminder.id) {
          let days: string[] = [];
          if (newReminder.days.includes(day)) {
            days = newReminder.days.filter((d: string) => d !== day);
          } else {
            days = [...newReminder.days, day];
          }
          return { ...newReminder, days };
        }
        return newReminder;
      });
    });
  };

  const deleteNewReminder = (newReminderId: number) => {
    setNewReminders((prevNewReminders: Reminder[]) =>
      prevNewReminders.filter(
        (reminder: Reminder) => reminder.id !== newReminderId,
      ),
    );
  };

  const clearNewReminders = () => {
    setNewReminders([]);
    setTimePickerDate(new Date());
  };

  const onSaveNewReminders = () => {
    setNewHabit((prevNewHabit: NewHabit) => ({
      ...prevNewHabit,
      reminders: newReminders,
    }));
    closeReminderBottomSheet();
    setNewReminders([]);
  };

  const onOpenReminderBottomSheet = () => {
    setNewReminders(newHabit.reminders);
    openReminderBottomSheet();
  };

  const onCloseReminderBottomSheet = () => {
    setNewReminders([]);
  };
  // reminder end

  // completions per day start
  const incrementTargetPerDay = () => {
    if (newHabit.targetPerDay < 10) {
      setNewHabit((prev) => ({
        ...prev,
        targetPerDay: prev.targetPerDay + 1,
      }));
    }
  };

  const decrementTargetPerDay = () => {
    console.log("increment");
    if (newHabit.targetPerDay > 1) {
      setNewHabit((prev) => ({
        ...prev,
        targetPerDay: prev.targetPerDay - 1,
      }));
    }
  };

  const handleChangeTargetPerDay = (value: string) => {
    if (/^\d*$/.test(value)) {
      setNewHabit((prev) => ({ ...prev, targetPerDay: parseInt(value) }));
    }
  };

  const createCategory = async (newCategory: Omit<Category, "id">) => {
    try {
      const category = await categoryRepositroy.create(newCategory);
      categories;
      setCategories((prevCategories) => [...prevCategories, category]);
    } catch (error) {}
  };

  const saveNewHabit = async () => {
    console.log(newHabit.targetPerDay);
    // save reminders
    try {
      await habitRepository.create({
        name: newHabit.name,
        description: newHabit.description,
        color: newHabit.color,
        frequency: newHabit.frequency,
        targetPerDay: newHabit.targetPerDay,
        requiredLogs: newHabit.requiredLogs,
        reminders: newHabit.reminders.map((reminder) => ({
          time: reminder.time.getTime().toString(),
          index: reminder.index,
          days: reminder.days.map((d) => ({ day: d })),
        })),
        logs: [],
        category: newHabit.category,
      });
      setNewHabit(newHabitDefaultValues);
      closeNewCategoryBottomSheet();
      closeNewHabitBottomSheet();
      const allHabits = await habitRepository.getAll();
      console.log("all habits ", allHabits);
    } catch (err) {
      console.log("error creating habit", err);
    }
  };
  useEffect(() => {
    const fetchHabit = async () => {
      try {
        const allHabits = await habitRepository.getAll();
        console.log("all habits ", allHabits);
        allHabits.forEach((habit) => {
          console.log(habit);
        });
      } catch (error) {
        console.log("error", error);
      }
    };
    fetchHabit();
  }, []);

  useEffect(() => {
    const fetchCategories = async () => {
      try {
        const categories_list = await categoryRepositroy.getAll();
        setCategories(categories_list);
        console.log("categories list: ", categories_list);
      } catch (error) {}
    };
    fetchCategories();
  }, []);

  const selectCategory = (category: Category) => {
    setNewHabit((prev) => ({ ...prev, category }));
  };
  // completions per day end

  const selectNewCatergoryIcon = ({
    icon,
    library,
  }: {
    icon: string;
    library: string;
  }) => {
    setNewCategory((prevNewCategory) => ({
      name: prevNewCategory.name,
      icon,
      library,
    }));
  };

  const handleChangeNewCategoryName = () => {};
  return {
    newHabit,
    handleNewHabitFieldChange,
    onSaveNewReminders,
    clearNewReminders,
    toggleNewReminderDay,
    newReminders,
    isTimePickerOpen,
    openTimePicker,
    deleteNewReminder,
    addNewReminder,
    reminderBottomSheetRef,
    onChangeNewReminderTime,
    timePickerDate,
    onOpenReminderBottomSheet,
    onCloseReminderBottomSheet,
    incrementTargetPerDay,
    decrementTargetPerDay,
    handleChangeTargetPerDay,
    newHabitBottomSheetRef,
    openNewHabitBottomSheet,
    closeNewHabitBottomSheet,
    onCloseNewHabitBottomSheet,
    categories,
    saveNewHabit,
    selectCategory,
    createCategory,
    selectNewCatergoryIcon,
    handleChangeNewCategoryName,
  };
};
export default useNewHabit;
